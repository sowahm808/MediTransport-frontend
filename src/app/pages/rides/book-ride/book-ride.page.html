<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>{{ getStepTitle(step) }}</ion-title>
    <ion-chip slot="end" color="light">
      Step {{ step }} of {{ totalSteps }}
    </ion-chip>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="booking-content">
  <div class="booking-container">
    <!-- Progress Indicator -->
    <div class="progress-container">
      <div class="progress-bar">
        <div
          class="progress-fill"
          [style.width.%]="(step / totalSteps) * 100">
        </div>
      </div>
      <div class="step-indicators">
        <div
          *ngFor="let stepNum of [1,2,3,4]"
          class="step-indicator"
          [class.active]="stepNum <= step"
          [class.current]="stepNum === step">
          {{ stepNum }}
        </div>
      </div>
    </div>

    <form [formGroup]="bookingForm" (ngSubmit)="confirmBooking()">

      <!-- Step 1: Pickup & Destination -->
      <div class="step-content" *ngIf="step === 1">
        <ion-card class="location-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="location-outline"></ion-icon>
              Where are we going?
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <!-- Pickup Location -->
            <div class="location-input-container">
              <ion-item lines="full" class="location-item">
                <ion-icon name="radio-button-on" slot="start" color="primary"></ion-icon>
                <ion-label position="stacked">Pickup Location</ion-label>
                <ion-input
                  formControlName="pickupAddress"
                  placeholder="Enter pickup address"
                  [clear-input]="true">
                </ion-input>
                <ion-button
                  fill="clear"
                  slot="end"
                  (click)="getCurrentLocation()"
                  [disabled]="currentLocationLoading">
                  <ion-spinner name="crescent" *ngIf="currentLocationLoading"></ion-spinner>
                  <ion-icon name="navigate-outline" *ngIf="!currentLocationLoading"></ion-icon>
                </ion-button>
              </ion-item>

              <!-- Pickup Suggestions -->
              <ion-list class="suggestions-list" *ngIf="showPickupSuggestions">
                <ion-item
                  button
                  *ngFor="let suggestion of pickupSuggestions"
                  (click)="selectPickupLocation(suggestion)">
                  <ion-icon name="location-outline" slot="start" color="medium"></ion-icon>
                  <ion-label>
                    <h3>{{ suggestion.structured_formatting?.main_text }}</h3>
                    <p>{{ suggestion.structured_formatting?.secondary_text }}</p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </div>

            <!-- Destination Location -->
            <div class="location-input-container">
              <ion-item lines="full" class="location-item">
                <ion-icon name="location" slot="start" color="danger"></ion-icon>
                <ion-label position="stacked">Destination</ion-label>
                <ion-input
                  formControlName="dropoffAddress"
                  placeholder="Enter destination address"
                  [clear-input]="true">
                </ion-input>
              </ion-item>

              <!-- Dropoff Suggestions -->
              <ion-list class="suggestions-list" *ngIf="showDropoffSuggestions">
                <ion-item
                  button
                  *ngFor="let suggestion of dropoffSuggestions"
                  (click)="selectDropoffLocation(suggestion)">
                  <ion-icon name="location-outline" slot="start" color="medium"></ion-icon>
                  <ion-label>
                    <h3>{{ suggestion.structured_formatting?.main_text }}</h3>
                    <p>{{ suggestion.structured_formatting?.secondary_text }}</p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </div>

            <!-- Booking Type -->
            <ion-radio-group formControlName="bookingType" class="booking-type-selector">
              <ion-item lines="none">
                <ion-radio slot="start" value="now"></ion-radio>
                <ion-label>
                  <h3>Book Now</h3>
                  <p>Immediate pickup</p>
                </ion-label>
              </ion-item>
              <ion-item lines="none">
                <ion-radio slot="start" value="scheduled"></ion-radio>
                <ion-label>
                  <h3>Schedule Later</h3>
                  <p>Choose a specific time</p>
                </ion-label>
              </ion-item>
            </ion-radio-group>

            <!-- Scheduled Time -->
            <ion-item
              lines="full"
              *ngIf="bookingForm.get('bookingType')?.value === 'scheduled'">
              <ion-icon name="time-outline" slot="start" color="medium"></ion-icon>
              <ion-label>Pickup Time</ion-label>
              <ion-datetime-button datetime="scheduled-time"></ion-datetime-button>
            </ion-item>
          </ion-card-content>
        </ion-card>

        <!-- Map Container -->
        <ion-card class="map-card">
          <ion-card-content>
            <div #mapContainer class="map-container"></div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Step 2: Vehicle Selection -->
      <div class="step-content" *ngIf="step === 2">
        <ion-card class="vehicle-selection-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="car-outline"></ion-icon>
              Choose Your Vehicle
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-radio-group formControlName="vehicleType">
              <div class="vehicle-options">
                <div
                  *ngFor="let vehicle of vehicleOptions"
                  class="vehicle-option"
                  [class.selected]="bookingForm.get('vehicleType')?.value === vehicle.type"
                  [class.unavailable]="!vehicle.available">

                  <ion-item lines="none" button>
                    <ion-radio slot="start" [value]="vehicle.type" [disabled]="!vehicle.available"></ion-radio>
                    <div class="vehicle-info">
                      <div class="vehicle-header">
                        <ion-icon [name]="vehicle.icon" size="large" color="primary"></ion-icon>
                        <div class="vehicle-details">
                          <h3>{{ vehicle.name }}</h3>
                          <p>{{ vehicle.description }}</p>
                        </div>
                        <div class="vehicle-rate">
                          <ion-badge color="primary">${{ vehicle.baseRate }}/mile</ion-badge>
                        </div>
                      </div>
                      <div class="vehicle-features">
                        <ion-chip
                          *ngFor="let feature of vehicle.features"
                          size="small"
                          color="light">
                          <ion-icon name="checkmark-circle-outline" size="small"></ion-icon>
                          {{ feature }}
                        </ion-chip>
                      </div>
                    </div>
                  </ion-item>
                </div>
              </div>
            </ion-radio-group>
          </ion-card-content>
        </ion-card>

        <!-- Route Information -->
        <ion-card class="route-info-card" *ngIf="routeInfo">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="map-outline"></ion-icon>
              Route Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-grid>
              <ion-row>
                <ion-col size="6">
                  <div class="route-stat">
                    <ion-icon name="navigate-outline" color="primary"></ion-icon>
                    <div>
                      <h3>{{ routeInfo.distance }}</h3>
                      <p>Distance</p>
                    </div>
                  </div>
                </ion-col>
                <ion-col size="6">
                  <div class="route-stat">
                    <ion-icon name="time-outline" color="secondary"></ion-icon>
                    <div>
                      <h3>{{ routeInfo.duration }}</h3>
                      <p>Duration</p>
                    </div>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Step 3: Trip Details -->
      <div class="step-content" *ngIf="step === 3">
        <ion-card class="trip-details-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="clipboard-outline"></ion-icon>
              Trip Details
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <!-- Passenger Count -->
            <ion-item lines="full">
              <ion-icon name="people-outline" slot="start" color="medium"></ion-icon>
              <ion-label>Number of Passengers</ion-label>
              <ion-select formControlName="passengerCount" placeholder="Select">
                <ion-select-option *ngFor="let i of [1,2,3,4,5,6]" [value]="i">
                  {{ i }} {{ i === 1 ? 'passenger' : 'passengers' }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <!-- Special Requirements -->
            <ion-item lines="full">
              <ion-icon name="medical-outline" slot="start" color="medium"></ion-icon>
              <ion-label position="stacked">Special Requirements</ion-label>
              <ion-textarea
                formControlName="specialRequirements"
                placeholder="Any medical equipment, mobility aids, or special needs"
                rows="3"
                [auto-grow]="true">
              </ion-textarea>
            </ion-item>

            <!-- Emergency Contact -->
            <ion-item lines="full">
              <ion-icon name="call-outline" slot="start" color="medium"></ion-icon>
              <ion-label position="stacked">Emergency Contact</ion-label>
              <ion-input
                formControlName="emergencyContact"
                type="tel"
                placeholder="Emergency contact phone number">
              </ion-input>
            </ion-item>

            <!-- Payment Method -->
            <ion-item lines="full">
              <ion-icon name="card-outline" slot="start" color="medium"></ion-icon>
              <ion-label>Payment Method</ion-label>
              <ion-select formControlName="paymentMethod">
                <ion-select-option value="card">Credit/Debit Card</ion-select-option>
                <ion-select-option value="insurance">Insurance</ion-select-option>
                <ion-select-option value="cash">Cash</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-card-content>
        </ion-card>

        <!-- Fare Estimate -->
        <ion-card class="fare-estimate-card" *ngIf="estimatedFare > 0">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="cash-outline"></ion-icon>
              Fare Estimate
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="fare-breakdown">
              <div class="fare-line">
                <span>Base Rate</span>
                <span>$5.00</span>
              </div>
              <div class="fare-line" *ngIf="routeInfo">
                <span>Distance ({{ routeInfo.distance }})</span>
                <span>${{ ((estimatedFare - 5) | number:'1.2-2') }}</span>
              </div>
              <div class="fare-line total">
                <span><strong>Estimated Total</strong></span>
                <span><strong>{{ formatCurrency(estimatedFare) }}</strong></span>
              </div>
            </div>
            <p class="fare-note">
              <ion-icon name="information-circle-outline"></ion-icon>
              Final fare may vary based on actual route and time
            </p>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Step 4: Confirmation -->
      <div class="step-content" *ngIf="step === 4">
        <ion-card class="confirmation-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              Confirm Your Booking
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <!-- Trip Summary -->
            <div class="booking-summary">
              <div class="summary-section">
                <h3>Trip Details</h3>
                <div class="summary-item">
                  <ion-icon name="radio-button-on" color="primary"></ion-icon>
                  <div>
                    <strong>Pickup:</strong>
                    <p>{{ pickupLocation?.address }}</p>
                  </div>
                </div>
                <div class="summary-item">
                  <ion-icon name="location" color="danger"></ion-icon>
                  <div>
                    <strong>Destination:</strong>
                    <p>{{ dropoffLocation?.address }}</p>
                  </div>
                </div>
                <div class="summary-item">
                  <ion-icon name="time-outline" color="medium"></ion-icon>
                  <div>
                    <strong>Time:</strong>
                    <p>{{ formatTime(bookingForm.get('scheduledTime')?.value) }}</p>
                  </div>
                </div>
              </div>

              <div class="summary-section">
                <h3>Vehicle & Passengers</h3>
                <div class="summary-item">
                  <ion-icon [name]="selectedVehicle?.icon || 'car-outline'" color="primary"></ion-icon>
                  <div>
                    <strong>{{ selectedVehicle?.name }}</strong>
                    <p>{{ bookingForm.get('passengerCount')?.value }} passenger(s)</p>
                  </div>
                </div>
              </div>

              <div class="summary-section" *ngIf="bookingForm.get('specialRequirements')?.value">
                <h3>Special Requirements</h3>
                <p>{{ bookingForm.get('specialRequirements')?.value }}</p>
              </div>

              <div class="summary-section">
                <h3>Payment</h3>
                <div class="summary-item">
                  <ion-icon name="card-outline" color="medium"></ion-icon>
                  <div>
                    <strong>{{ bookingForm.get('paymentMethod')?.value | titlecase }}</strong>
                    <p>Estimated fare: {{ formatCurrency(estimatedFare) }}</p>
                  </div>
                </div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Navigation Buttons -->
      <div class="navigation-buttons">
        <ion-button
          fill="outline"
          color="medium"
          (click)="previousStep()"
          *ngIf="step > 1">
          <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
          Previous
        </ion-button>

        <ion-button
          fill="solid"
          color="primary"
          (click)="nextStep()"
          [disabled]="!canProceedToStep(step + 1)"
          *ngIf="step < totalSteps">
          Next
          <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
        </ion-button>

        <ion-button
          fill="solid"
          color="success"
          type="submit"
          [disabled]="!bookingForm.valid || isLoading"
          *ngIf="step === totalSteps">
          <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
          <span *ngIf="!isLoading">Confirm Booking</span>
          <span *ngIf="isLoading">Booking...</span>
        </ion-button>
      </div>
    </form>
  </div>

  <!-- Datetime Modal -->
  <ion-modal trigger="scheduled-time">
    <ng-template>
      <ion-datetime
        id="scheduled-time"
        formControlName="scheduledTime"
        presentation="date-time"
        [min]="new Date().toISOString()"
        [showDefaultButtons]="true">
      </ion-datetime>
    </ng-template>
  </ion-modal>
</ion-content>
